#!/usr/bin/env bash

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
source "$SCRIPT_DIR/functions.sh"
MOD_DIR="$(pwd)"

if [ -z "$1" ]; then
    echo "Usage: $0 <relative_file_path>" >&2
    echo "Example: $0 gui/information_panel_bar.gui" >&2
    echo "Output: Patch will be printed to standard output (stdout)." >&2
    echo "Information/Errors will be printed to standard error (stderr)." >&2
    exit 1
fi

RELATIVE_FILE_PATH="$1"
VIC3VERSION=$(vic3_version)
VERSIONED_FILE_PATH="$RELATIVE_FILE_PATH.$VIC3VERSION"

GAME_BASE_PATH=$(game_install_dir "$VIC3_APP_ID")

if [ $? -ne 0 ]; then
    echo "Error: Failed to find Victoria 3 installation path. Exiting." >&2
    exit 1
fi

SOURCE_GAME_FILE="$GAME_BASE_PATH/game/$RELATIVE_FILE_PATH"
SOURCE_MOD_FILE="$MOD_DIR/$RELATIVE_FILE_PATH"

# Check if both files exist
if [ ! -f "$SOURCE_GAME_FILE" ]; then
    echo "Error: Original game file not found: '$SOURCE_GAME_FILE'" >&2
    exit 1
fi

if [ ! -f "$SOURCE_MOD_FILE" ]; then
    echo "Error: Modded file not found: '$SOURCE_MOD_FILE'" >&2
    echo "Please ensure you have modified the file in your mod directory first." >&2
    exit 1
fi

diff -u \
    --label "a/$VERSIONED_FILE_PATH" "$SOURCE_GAME_FILE" \
    --label "b/$RELATIVE_FILE_PATH" "$SOURCE_MOD_FILE"

DIFF_STATUS=$?

if [ "$DIFF_STATUS" -eq 0 ]; then
    echo "Patch generated successfully (no differences found)." >&2
    echo "Note: An empty patch means the files are identical." >&2
    echo "To save to a file, redirect stdout: $0 <file> > <patch_file.patch>" >&2
elif [ "$DIFF_STATUS" -eq 1 ]; then
    echo "Patch generated successfully (differences found and printed above)." >&2
    echo "To save to a file, redirect stdout: $0 <file> > <patch_file.patch>" >&2
else
    echo "Error: 'diff' command encountered an issue (exit code $DIFF_STATUS)." >&2
    exit 1
fi

exit 0
